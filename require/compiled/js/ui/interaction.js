define(["require","exports","module","jquery","jquery-ui","./dialog","js/storage","./layout","js/files"],function(e,t,n){function f(e){a||(a=!0,e(),a=!1)}function l(e){var t=r(".b-menu"),n={save:t.find(".b-menu__menu-item_command_save"),load:t.find(".b-menu__menu-item_command_load"),print:t.find(".b-menu__menu-item_command_print"),upload:t.find(".b-menu__menu-item_command_upload"),download:t.find(".b-menu__menu-item_command_download")};r.each(n,function(){r(this).button()}),n.save.button("disable"),n.load.button("disable"),s.supported&&(n.save.click(function(t){f(function(){s.set("modeldata",e.lectures())})}),n.load.click(function(t){f(function(){var t=s.get("modeldata");t&&t.length&&e.init(t)})}),n.print.click(function(t){f(function(){s.set("modeldata",e.lectures())})}));var o=!1,a=function(){!o&&s.supported&&(n.save.button("enable"),n.load.button("enable"),o=!0)};e.on("lecture.add",a),e.on("lecture.remove",a),e.on("init",function(){n.save.removeClass("ui-state-hover").button("disable"),n.load.removeClass("ui-state-hover").button("disable"),o=!1}),JSON&&(n.upload.click(function(){i.getJSON(function(t){var n;try{n=JSON.parse(t.data)}catch(r){n=""}n&&n.length&&f(function(){e.init(n)})})}),n.download.click(function(t){var r=JSON.stringify(e.lectures()||"");r&&f(function(){if(u.supported){var s=n.download;s.attr("download","model.json"),s.attr("href",u.href(r))}else t.preventDefault(),i.provideJSON(JSON.stringify(e.lectures()||""))})}))}function c(e){r(".b-content__workspace-control_action_prepend").click(function(){e.prependWeek()}),r(".b-content__workspace-control_action_append").click(function(){e.appendWeek()})}var r=e("jquery");e("jquery-ui");var i=e("./dialog"),s=e("js/storage"),o=e("./layout"),u=e("js/files"),a=!1;t.init=function(e){r(function(){o.on("new.day",function(t){this.click(function(){var n={date:t.isoDate,start:t.lectures.length?t.lectures[t.lectures.length-1].end:"12:00"};n.end=n.start.replace(/\d{2}:/,function(e){return parseInt(e)+1+":"}),i.create(this,n,function(t){e.add(t)})})}),o.on("new.lecture",function(t){this.on("click",".b-curriculum__lecture-action_remove",function(n){e.remove(t),n.stopPropagation()}),this.click(function(n){i.change(this,t,function(r){e.remove(t),e.add(r)},function(){e.remove(t)}),n.stopPropagation()})});var t=r(this.body);o.on("clear",function(){t.addClass("b-content_state_unloaded")}),o.on("init",function(){t.removeClass("b-content_state_unloaded")}),l(e),o.init(e),c(e)})}})