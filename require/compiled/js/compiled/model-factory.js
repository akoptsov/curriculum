define(["require","exports","module","./events"],function(e,t,n){function s(e,t){return function(){t.apply(e,Array.prototype.slice.call(arguments,0))}}function o(e){return(e<10?"0":"")+e}function u(e){return e.getFullYear()+"-"+o(e.getMonth()+1)+"-"+o(e.getDate())}function f(e){var t=a.exec(e);if(t===null||t.length<4)return console.log("failed to parse an ISO date from ",e),undefined;var n=parseInt(t[1]),r=parseInt(t[2].replace(/^0*/,""))-1,i=parseInt(t[3].replace(/^0*/,""));return!n||!r||!i?(console.log("failed to parse an ISO date from ",e),undefined):new Date(n,r,i,0,0,0,0)}function l(e){var t=new Date(e),n=t.getDay();return t.setDate(t.getDate()-(n?n:7)+1),t}function c(e){var t=new Date(e),n=t.getDay();return n&&t.setDate(t.getDate()-n+7),t}function p(e){this.isoDate=u(e),this.display={day:h[e.getDay()],date:e.getDate()+"."+o(e.getMonth()+1)},this.lectures=[];var t=new r.Emitter;this.on=s(this,t.on),this.emit=s(this,t.emit),this.off=s(this,t.off)}function d(e){var t=this.monday=l(e),n=this.sunday=c(e),r=this.days=[];for(var i=new Date(t);i<=n;i.setDate(i.getDate()+1))r.push(new p(i))}function v(e){function c(e){e.date||console.error("can't add a lecture without date!");var t=p(e.date),n=t.add(e);l("lecture.add",e,t,n)}function h(e){e.date||console.error("can't remove lecture without a date!");var t=p(e.date),n=t.remove(e);l("lecture.remove",e,t,n)}function p(e){var t=f(e),r;if(!o&&!u)r=v(t);else{while(o>t)r=m();while(u<t)r=g();if(!r){var i=0;do r=n[i++];while(!r.contains(t))}}return r&&r.day(t)}function v(e){var t=new d(e);return n.push(t),o=new Date(t.monday),u=new Date(t.sunday),l("week.append",t),t}function m(){o.setDate(o.getDate()-7);var e=new d(o);return n.splice(0,0,e),l("week.prepend",e),e}function g(){u.setDate(u.getDate()+7);var e=new d(u);return n.push(e),l("week.append",e),e}function b(){y.weeks=n=[],o=u=undefined,l("clear")}function w(e){n.length&&b();var t=l;l=function(){};if(e&&e.length)for(var r=0,s=e.length;r<s;r++)c(e[r]);if(i&&i.viewport){n.length||v(new Date);while(n.length<i.viewport)g()}l=t,l("init")}function E(){var e=[];for(var t=0,r=n.length;t<r;t++)for(var i=0,s=n[t].days.length;i<s;i++)for(var o=0,u=n[t].days[i].lectures.length;o<u;o++)e.push(n[t].days[i].lectures[o]);return e}var t=[],n=[],o,u,a=new r.Emitter,l=s(this,a.emit),y=this;this.weeks=n,this.appendWeek=g,this.prependWeek=m,this.lectures=E,this.add=c,this.remove=h,this.init=w,this.on=s(this,a.on),this.off=s(this,a.off),w(e)}var r=e("./events"),i=n.config(),a=/\s*(\d+)-(\d+)-(\d+)\s*/,h=["Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"];p.prototype.add=function(e){var t=this.lectures,n=t.length,r=0;while(r<n&&t[r].start<e.start)r++;return t.splice(r,0,e),this.emit("add",r,e),r},p.prototype.remove=function(e){var t=this.lectures,n=t.length,r=0;while(r<n&&t[r]!==e)r++;return r<n?(this.emit("remove",r,t.splice(r,1)),r):-1},d.prototype.contains=function(e){return this.monday<=e&&this.sunday>=e},d.prototype.day=function(e){if(this.contains(e))return this.days[(e.getDay()+6)%7]},t.Model=v})