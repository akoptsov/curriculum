define("js/global",["require"],function(e){return window}),define("js/storage",["require","exports","module","./global"],function(e,t,n){function r(e){return typeof e=="string"?e:o.stringify(e)}function i(e){return e?o.parse(e):e}var s=e("./global"),o=s.JSON,u=s.localStorage;u&&o?(t.supported=!0,t.has=function(e){return typeof u.getItem(e)=="string"},t.get=function(e){return i(u.getItem(e))},t.set=function(e,t){u.setItem(e,r(t))},t.remove=function(e){u.removeItem(e)}):t.supported=!1}),define("js/events",["require","exports","module"],function(e,t,n){function r(){var e=[];this.subscribe=function(t){typeof t=="function"&&e.push(t)},this.unsubscribe=function(t){if(typeof t!="function")return;var n=-1;for(var r=0,i=e.length;r<i;r++)if(e[r]===t){n=r;break}n>-1&&e.splice(n,1)},this.emit=function(){for(var t=0,n=e.length;t<n;t++)e[t].apply(this,Array.prototype.slice.call(arguments,0))}}function i(){var e={};this.emit=function(t){t&&e[t]&&e[t].emit.apply(this,Array.prototype.slice.call(arguments,1))},this.on=function(t,n){e[t]=e[t]||new r,e[t].subscribe(n)},this.off=function(t,n){e[t]&&e[t].unsubscribe(n)}}function s(e){var t=[],n=!1,r=[];if(typeof e!="function"){console.error("Promise condition should be a function"),n=!!e;return}this.check=function(){if(n)return;var i=Array.prototype.slice.call(arguments,0);if(e.apply(this,i)){n=!0,r=i;for(var s=0,o=t.length;s<o;s++)t[s].apply(this,i)}},this.success=function(e){if(!typeof e==="function")return;n?e.apply(this,r):t.push(e)}}t.Event=r,t.Emitter=i,t.Promise=s,t.Bus=new i}),define("js/model-factory",["require","exports","module","./events"],function(e,t,n){function r(e,t){return function(){t.apply(e,Array.prototype.slice.call(arguments,0))}}function i(e){return(e<10?"0":"")+e}function s(e){return e.getFullYear()+"-"+i(e.getMonth()+1)+"-"+i(e.getDate())}function o(e){var t=d.exec(e);if(t===null||t.length<4)return console.log("failed to parse an ISO date from ",e),undefined;var n=parseInt(t[1]),r=parseInt(t[2].replace(/^0*/,""))-1,i=parseInt(t[3].replace(/^0*/,""));return!n||!r||!i?(console.log("failed to parse an ISO date from ",e),undefined):new Date(n,r,i,0,0,0,0)}function u(e){var t=new Date(e),n=t.getDay();return t.setDate(t.getDate()-(n?n:7)+1),t}function a(e){var t=new Date(e),n=t.getDay();return n&&t.setDate(t.getDate()-n+7),t}function f(e){this.isoDate=s(e),this.display={day:v[e.getDay()],date:e.getDate()+"."+i(e.getMonth()+1)},this.lectures=[];var t=new h.Emitter;this.on=r(this,t.on),this.emit=r(this,t.emit),this.off=r(this,t.off)}function l(e){var t=this.monday=u(e),n=this.sunday=a(e),r=this.days=[];for(var i=new Date(t);i<=n;i.setDate(i.getDate()+1))r.push(new f(i))}function c(e){function t(e){e.date||console.error("can't add a lecture without date!");var t=i(e.date),n=t.add(e);w("lecture.add",e,t,n)}function n(e){e.date||console.error("can't remove lecture without a date!");var t=i(e.date),n=t.remove(e);w("lecture.remove",e,t,n)}function i(e){var t=o(e),n;if(!g&&!y)n=s(t);else{while(g>t)n=u();while(y<t)n=a();if(!n){var r=0;do n=m[r++];while(!n.contains(t))}}return n&&n.day(t)}function s(e){var t=new l(e);return m.push(t),g=new Date(t.monday),y=new Date(t.sunday),w("week.append",t),t}function u(){g.setDate(g.getDate()-7);var e=new l(g);return m.splice(0,0,e),w("week.prepend",e),e}function a(){y.setDate(y.getDate()+7);var e=new l(y);return m.push(e),w("week.append",e),e}function f(){E.weeks=m=[],g=y=undefined,w("clear")}function c(e){m.length&&f();var n=w;w=function(){};if(e&&e.length)for(var r=0,i=e.length;r<i;r++)t(e[r]);if(p&&p.viewport){m.length||s(new Date);while(m.length<p.viewport)a()}w=n,w("init")}function d(){var e=[];for(var t=0,n=m.length;t<n;t++)for(var r=0,i=m[t].days.length;r<i;r++)for(var s=0,o=m[t].days[r].lectures.length;s<o;s++)e.push(m[t].days[r].lectures[s]);return e}var v=[],m=[],g,y,b=new h.Emitter,w=r(this,b.emit),E=this;this.weeks=m,this.appendWeek=a,this.prependWeek=u,this.lectures=d,this.add=t,this.remove=n,this.init=c,this.on=r(this,b.on),this.off=r(this,b.off),c(e)}var h=e("./events"),p=n.config(),d=/\s*(\d+)-(\d+)-(\d+)\s*/,v=["Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"];f.prototype.add=function(e){var t=this.lectures,n=t.length,r=0;while(r<n&&t[r].start<e.start)r++;return t.splice(r,0,e),this.emit("add",r,e),r},f.prototype.remove=function(e){var t=this.lectures,n=t.length,r=0;while(r<n&&t[r]!==e)r++;return r<n?(this.emit("remove",r,t.splice(r,1)),r):-1},l.prototype.contains=function(e){return this.monday<=e&&this.sunday>=e},l.prototype.day=function(e){if(this.contains(e))return this.days[(e.getDay()+6)%7]},t.Model=c}),define("js/ui/forms",["require","exports","module","jquery"],function(e,t,n){function r(e,t){var n={required:function(){return"Поле является обязательным"},format:function(e){return"Формат для поля : "+e},"default":function(e){return e}};return{name:t,message:n[n[e]?e:"default"].apply(this,Array.prototype.slice.call(arguments,2))}}function i(e,t,n){this.container=e;var r={},o=this;$.each(t,function(e,t){var n=new s(o,e,t);n.element.length&&(r[e]=n)}),typeof n=="function"&&(this.validate=function(){return i.prototype.validate.call(this).concat(n.call(this))}),o.fields=r}function s(e,t,n){this.name=t,this.element=e.container.find("[name="+t+"]");if(!n&&!this.element)return;n.required&&(this.required=!0),$.isFunction(n.init)&&n.init.call(this),$.isFunction(n.get)&&(this.get=n.get),$.isFunction(n.set)&&(this.set=n.set),$.isFunction(n.validate)&&(this.validate=function(){return s.prototype.validate.call(this).concat(n.validate.call(this))})}$=e("jquery"),i.prototype.get=function(){var e={};return $.each(this.fields,function(t,n){e[t]=n.get()}),e},i.prototype.bind=function(e){var t=this;$.each(this.fields,function(e,t){t.set("")}),e&&typeof e=="object"&&$.each(e,function(n,r){t.fields[n]&&t.fields[n].set(e[n])})},i.prototype.validate=function(){var e=[];return $.each(this.fields,function(t,n){e=e.concat(n.validate())}),e},s.prototype.get=function(){return this.element.val()},s.prototype.set=function(e){this.element.val(e)},s.prototype.validate=function(){return this.required&&!this.get()?[new r("required",this.name)]:[]},t.Form=i,t.Error=r}),define("js/templates",["require","exports","module","handlebars","./events"],function(e,t,n){function r(e){if(!Handlebars){console.error("Handlebars is missing from the global scope");return}var n,r={"(":"{",")":"}"};while(n=u.exec(e))for(var i=0,s=n.length;i<s;i++)t[n[1]]=Handlebars.compile(n[2].replace(/[\(\)]/g,function(e){return r[e]||e})),o.check()}e("handlebars");var i=e("./events"),s=n.config().required,o=new i.Promise(function(){if(!s&&!s.length)return!0;for(var e=0,n=s.length;e<n;e++)if(!t[s[e]])return!1;return!0}),u=/<!--\s*([\w$-]+)\s*-->\s*([\s\S]+?)\s*(?=<!--\s*[\w$-]+\s*-->|$)/g;e(["text!templates/templates.html"],function(e){e&&r(e)}),t.ready=o}),define("js/ui/dialog",["require","exports","module","jquery","./forms","js/events","js/templates","jquery-ui.ru"],function(e,t,n){function r(e,t,n){var r={autoOpen:!1,modal:!0,resizable:!1,width:"auto",maxWidth:600,dialogClass:"b-dialog"},i={};return i.dlg=c(e).dialog(c.extend(!0,r,t)),i.form=new h.Form(i.dlg,n),i}function i(e){return parseInt(e.replace(/^0/,""))}function s(){var e=this.get();if(!e)return[];var t=y.exec(e);return!t||!t.length?[new h.Error("format",this.name,"[http|https|ftp]://...")]:[]}function o(){return c.trim(this.element.val())}function u(){var e=/^\s*([0-2]\d):([0-5]\d)\s*$/.exec(this.get());return e?[]:[new h.Error("format",this.name,"hh:mm")]}function a(e,t){var n=e.form,r=n.validate();r.length?c.each(r,function(e,t){var r=n.fields[t.name].element,i=r.closest(".b-form__field");i.addClass(w).find(E).text(t.message),r.one("focus",function(e){i.removeClass(w).find(E).text("")})}):(c.isFunction(t)&&t(n.get()),e.dlg.dialog("close"))}function f(e){c.isFunction(e)&&e(),c(this).dialog("close")}function l(e,t,n){g(function(){e.form.bind(t),e.dlg.dialog("option",n).dialog("open")})}var c=e("jquery"),h=e("./forms"),p=e("js/events"),d=e("js/templates");e("jquery-ui.ru");var v,m,g=d.ready.success;c.widget("ui.timespinner",c.ui.spinner,{options:{min:0,max:1439,step:1,page:60},_parse:function(e){if(typeof e=="string"){var t=/^\s*([0-2]\d):([0-5]\d)\s*$/.exec(e);if(t){var n=this._int(t[1]),r=this._int(t[2]);if(!isNaN(n)&&!isNaN(r))return n*60+r}}else if(typeof e=="number")return e},_format:function(e){return this._topzero(~~(e/60))+":"+this._topzero(e%60)},_topzero:function(e){return(e<10?"0":"")+e},_int:i});var y=/^\s*(?:https?|ftp):\/\/.+/,b={date:{required:!0,init:function(){this.element.datepicker({showButtonPanel:!0,showOn:"button",dateFormat:"yy-mm-dd"})}},start:{required:!0,init:function(){this.element.timespinner()},validate:u},end:{required:!0,init:function(){this.element.timespinner()},validate:u},title:{required:!0,get:o},person:{required:!0,get:o},points:{get:o},presentation:{get:o,validate:s},video:{get:o,validate:s}},w="b-form__field_state_invalid",E=".b-form__field-error-message";g(function(){v=r(d["dialog-change"](),{},b),m=r(d["dialog-textdata"](),{resizable:!0,width:"auto",maxWidth:1e3},{data:{}})}),t.create=function(e,t,n){l(v,t,{title:"Новая лекция",buttons:[{text:"ОК",click:function(){a(v,n)}},{text:"Отмена",click:f}]})},t.change=function(e,t,n,r){l(v,t,{title:"Изменить информацию",buttons:[{text:"ОК",click:function(){a(v,n)}},{text:"Отмена",click:f},{text:"Удалить",click:function(){f.call(this,r)}}]})},t.getJSON=function(e){l(m,{},{title:"Создать из JSON",buttons:[{text:"ОК",click:function(){a(m,e)}},{text:"Отмена",click:f}]})},t.provideJSON=function(e){l(m,{data:e},{title:"Расписание в формате JSON",buttons:[{text:"ОК",click:f}]})}}),define("js/ui/layout",["require","exports","module","jquery","js/templates","js/events"],function(e,t,n){function r(e,t){var n=u(a.day(t)),r=n.find(".b-curriculum__lectures-list");_dayLectures[t.isoDate]=r,u.each(t.lectures,function(e,t){c.add(r,t,-1)}),e.append(n),l.emit.call(n,"new.day",t)}function i(e,t,n){n=n||"append";var i=u(a.week(t));u.each(t.days,function(e,t){r(i,t)}),e[n](i),l.emit.call(i,"new.week",t)}function s(e,t){u.each(t.weeks,function(t,n){i(e,n)}),l.emit.call(e,"init",t)}function o(e){a.ready.success(function(){if(!e.weeks.length)return;if(!p||!p["static"])e.on("clear",function(){_dayLectures=[],h.empty(),l.emit.call(h,"clear")}),e.on("init",function(){s(h,this)}),e.on("week.prepend",function(e){i(h,e,"prepend")}),e.on("week.append",function(e){i(h,e,"append")}),e.on("lecture.add",function(e,t,n){c.add(_dayLectures[t.isoDate],e,n)}),e.on("lecture.remove",function(e,t,n){c.remove(_dayLectures[t.isoDate],e,n)});s(h,e)})}var u=e("jquery"),a=e("js/templates"),f=e("js/events"),l=new f.Emitter,c={add:function(e,t,n){var r=u(a.lecture(t)),i=e.children();return n>=0&&n<i.length?u(i[n]).before(r):e.append(r),l.emit.call(r,"new.lecture",t),r},remove:function(e,t,n){var r=e.children();n>=0&&n<=r.length&&(u(r[n]).remove(),l.emit.call(e,"removed.lecture",t))}};_dayLectures={};var h=u(".b-curriculum"),p=n.config();t.init=o,t.on=l.on,t.off=l.off}),define("js/files",["require","exports","module","./global"],function(e,t,n){function r(e){var t=new o;t.append(e);var n=t.getBlob("application/octet-stream");return s.createObjectURL(n)}var i=e("./global"),s=i.URL||i.webkitURL,o=i.BlobBuilder||i.WebKitBlobBuilder||i.MozBlobBuilder||i.MSBlobBuilder;this.supported=s&&o,this.href=r}),define("js/ui/interaction",["require","exports","module","jquery","jquery-ui","./dialog","js/storage","./layout","js/files"],function(e,t,n){function r(e){c||(c=!0,e(),c=!1)}function i(e){var t=o(".b-menu"),n={save:t.find(".b-menu__menu-item_command_save"),load:t.find(".b-menu__menu-item_command_load"),print:t.find(".b-menu__menu-item_command_print"),upload:t.find(".b-menu__menu-item_command_upload"),download:t.find(".b-menu__menu-item_command_download")};o.each(n,function(){o(this).button()}),n.save.button("disable"),n.load.button("disable"),a.supported&&(n.save.click(function(t){r(function(){a.set("modeldata",e.lectures())})}),n.load.click(function(t){r(function(){var t=a.get("modeldata");t&&t.length&&e.init(t)})}),n.print.click(function(t){r(function(){a.set("modeldata",e.lectures())})}));var i=!1,s=function(){!i&&a.supported&&(n.save.button("enable"),n.load.button("enable"),i=!0)};e.on("lecture.add",s),e.on("lecture.remove",s),e.on("init",function(){n.save.removeClass("ui-state-hover").button("disable"),n.load.removeClass("ui-state-hover").button("disable"),i=!1}),JSON&&(n.upload.click(function(){u.getJSON(function(t){var n;try{n=JSON.parse(t.data)}catch(i){n=""}n&&n.length&&r(function(){e.init(n)})})}),n.download.click(function(t){var i=JSON.stringify(e.lectures()||"");i&&r(function(){if(l.supported){var r=n.download;r.attr("download","model.json"),r.attr("href",l.href(i))}else t.preventDefault(),u.provideJSON(JSON.stringify(e.lectures()||""))})}))}function s(e){o(".b-content__workspace-control_action_prepend").click(function(){e.prependWeek()}),o(".b-content__workspace-control_action_append").click(function(){e.appendWeek()})}var o=e("jquery");e("jquery-ui");var u=e("./dialog"),a=e("js/storage"),f=e("./layout"),l=e("js/files"),c=!1,h=o(".b-content__wrapper");t.init=function(e){o(function(){f.on("new.day",function(t){this.click(function(){var n={date:t.isoDate,start:t.lectures.length?t.lectures[t.lectures.length-1].end:"12:00"};n.end=n.start.replace(/\d{2}:/,function(e){return parseInt(e)+1+":"}),u.create(this,n,function(t){e.add(t)})})}),f.on("new.lecture",function(t){this.on("click",".b-curriculum__lecture-action_remove",function(n){e.remove(t),n.stopPropagation()}),this.click(function(n){u.change(this,t,function(n){e.remove(t),e.add(n)},function(){e.remove(t)}),n.stopPropagation()})});var t=o(this.body);f.on("clear",function(){t.addClass("b-content_state_unloaded")}),f.on("init",function(){t.removeClass("b-content_state_unloaded")}),i(e),f.init(e),s(e)})}}),define("js/main",["require","exports","module","jquery","js/storage","js/global","js/model-factory","js/ui/interaction"],function(e,t,n){var r=e("jquery"),i=e("js/storage"),s=e("js/global"),o=e("js/model-factory"),u=e("js/ui/interaction"),a=i.get("modeldata");u.init(new o.Model(a))})